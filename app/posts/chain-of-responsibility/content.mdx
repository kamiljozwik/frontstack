import Image from "next/image";
import chain from "./chain.png";
import callCenter from "./callCenter.gif";
import wynik from "./wynik.png";

export const meta = {
  title: "Wzorzec: Chain Of Responsibility",
  seo_desc:
    'Wzorzec "Chain of responsibility", zwany rÃ³wnieÅ¼ Å‚aÅ„cuchem zobowiÄ…zaÅ„ jest wzorcem projektowym, dziÄ™ki ktÃ³remu moÅ¼emy tworzyÄ‡ moduÅ‚owy kod.',
  short:
    "Chcesz dowiedzieÄ‡ siÄ™, jak efektywnie zarzÄ…dzaÄ‡ zÅ‚oÅ¼onymi zadaniami w programowaniu? Zapoznaj siÄ™ z wzorcem projektowym Chain of Responsibility. Poznaj jego zalety, takie jak rozdzielenie obowiÄ…zkÃ³w i elastycznoÅ›Ä‡, oraz dowiedz siÄ™, jak zastosowaÄ‡ ten wzorzec w praktyce, aby ulepszyÄ‡ swoje projekty.",
  date: "2021-08-23",
  tags: ["Wzorce", "JavaScript"],
};

Chain of responsibility jest wzorcem behawioralnym, ktÃ³ry jest stosunkowo Å‚atwy do zrozumienia, wiÄ™c czÄ™Å›Ä‡ teoretyczna tego wpisu bÄ™dzie doÅ›Ä‡ krÃ³tka. PrzykÅ‚ady w tym przypadku przyniosÄ… nam wiÄ™kszÄ… korzyÅ›Ä‡ ğŸ™‚

## ÅaÅ„cuch zobowiÄ…zaÅ„

_Chain of responsibility_, zwany rÃ³wnieÅ¼ ÅaÅ„cuchem zobowiÄ…zaÅ„, pozwala nam podzieliÄ‡ obsÅ‚uÅ¼enie jakiegoÅ› zadania / Å¼Ä…dania przez wiele pojedynczych obiektÃ³w obsÅ‚ugujÄ…cych. Obiekty te sÄ… niejako poÅ‚Ä…czone jak za pomocÄ… Å‚aÅ„cucha i **realizujÄ… zadanie jeden po drugim**. JeÅ¼eli dany obiekt stwierdzi, iÅ¼ nie potrafi obsÅ‚uÅ¼yÄ‡ danego zadania, przekazuje je dalej do kolejnego obiektu. W Å‚aÅ„cuchu takim ostatni obiekt musi byÄ‡ przygotowany na to, Å¼e nie bÄ™dzie w stanie dalej przekazaÄ‡ zadania, wiÄ™c bÄ™dzie musiaÅ‚ jakoÅ› sobie z nim zawsze poradziÄ‡.

W przypadku gdy obiekt bÄ™dzie w stanie obsÅ‚uÅ¼yÄ‡ Å¼Ä…danie i w wyniku jego pracy zdecyduje o tym, Å¼e dalsze przetwarzanie nie ma sensu, **moÅ¼e on w tym momencie przerwaÄ‡ caÅ‚y Å‚aÅ„cuch** i zakoÅ„czyÄ‡ obsÅ‚ugÄ™ Å¼Ä…dania.

<img src={chain.src} alt="graficzna prezentacja Å‚aÅ„cucha zobowiÄ…zaÅ„" />

StosujÄ…c Å‚aÅ„cuch zobowiÄ…zaÅ„, delegujemy kaÅ¼demu z obiektÃ³w (kaÅ¼dej klasie/funkcji) **tylko jedno zadanie**. W ten sposÃ³b nasz kod robi siÄ™ duÅ¼o czytelniejszy oraz Å‚atwiejszy do utrzymania.

PosiadajÄ…c juÅ¼ zdefiniowane pojedyncze obiekty obsÅ‚ugujÄ…ce, nasz Å‚aÅ„cuch moÅ¼emy tworzyÄ‡ dynamicznie w zaleÅ¼noÅ›ci od aktualnych potrzeb. Musimy wiÄ™c dopilnowaÄ‡ rÃ³wnieÅ¼ zgodnoÅ›ci interfejsÃ³w (np. korzystajÄ…c z TypeScript lub rozszerzajÄ…c klasy bazowe).

## Wady i zalety

Wzorzec Chain of Responsibility oczywiÅ›cie ma swoje wady i zalety. NajwaÅ¼niejsze z nich moÅ¼emy znaleÅºÄ‡ poniÅ¼ej:

### Zalety ğŸ‘

- **Rozdzielenie obowiÄ…zkÃ³w**: ÅaÅ„cuch zobowiÄ…zaÅ„ pozwala na rozbicie odpowiedzialnoÅ›ci za obsÅ‚ugÄ™ Å¼Ä…daÅ„ pomiÄ™dzy wiele obiektÃ³w. KaÅ¼dy z obiektÃ³w ma jasno zdefiniowane zadanie, co pozwala na Å‚atwiejsze zarzÄ…dzanie kodem.
- **WiÄ™ksza elastycznoÅ›Ä‡**: Pozwala na dynamiczne tworzenie Å‚aÅ„cucha, a takÅ¼e modyfikowanie go w trakcie dziaÅ‚ania aplikacji.
- **Odmowa obsÅ‚ugi**: Przerwanie Å‚aÅ„cucha w dowolnym miejscu jest moÅ¼liwe, gdy dalsze przetwarzanie Å¼Ä…dania nie ma sensu.

### Wady ğŸ‘

- **WyÅ¼sza zÅ‚oÅ¼onoÅ›Ä‡**: Stosowanie wzorca Chain of Responsibility moÅ¼e wprowadziÄ‡ dodatkowÄ… zÅ‚oÅ¼onoÅ›Ä‡ do aplikacji, zwÅ‚aszcza gdy istnieje wiele obiektÃ³w i zaleÅ¼noÅ›ci pomiÄ™dzy nimi.
- **OpÃ³Åºnienia**: Stosowanie Å‚aÅ„cucha moÅ¼e prowadziÄ‡ do opÃ³ÅºnieÅ„, gdy Å¼Ä…danie musi przejÅ›Ä‡ przez wiele obiektÃ³w zanim zostanie obsÅ‚uÅ¼one.

## Kilka przykÅ‚adÃ³w

Jednym z nieprogramistycznych przykÅ‚adÃ³w obrazujÄ…cych ten wzorzec jest **call center**. W przypadku gdy chcemy dowiedzieÄ‡ siÄ™ czegoÅ›, korzystajÄ…c z infolinii, najprawdopodobniej w pierwszej kolejnoÅ›ci usÅ‚yszymy w sÅ‚uchawce automat. Automat ten bÄ™dzie pierwszym obiektem obsÅ‚ugujÄ…cym. ByÄ‡ moÅ¼e bÄ™dzie umiaÅ‚ od rozwiÄ…zaÄ‡ nasz problem, czytajÄ…c jakÄ…Å› gotowÄ… odpowiedÅº bÄ…dÅº rozÅ‚Ä…czy nas, gdy nie wyrazimy zgody na nagrywanie, ale w wiÄ™kszoÅ›ci przypadkÃ³w przekaÅ¼e nasze Å¼Ä…danie dalej, do pierwszej linii wsparcia. JeÅ¼eli tam rÃ³wnieÅ¼ siÄ™ nie uda, bÄ™dziemy przekazywani dalej, aÅ¼ w koÅ„cu ktoÅ› nam pomoÅ¼e, albo okaÅ¼e siÄ™, Å¼e nasz problem jest nie do rozwiÄ…zania przez telefon.

<img src={callCenter.src} />

Kolejnym przykÅ‚adem moÅ¼e byÄ‡ **praca bankomatu**. Po wybraniu odpowiedniej kwoty do wypÅ‚aty bankomat musi sprawdziÄ‡, czy posiadamy takie Å›rodki na koncie, czy w bankomacie jest wystarczajÄ…co duÅ¼o gotÃ³wki oraz zdecydowaÄ‡, w jakich nominaÅ‚ach wypÅ‚aciÄ‡ nam banknoty. Tutaj ponownie wszystkie te czynnoÅ›ci moÅ¼na wykonaÄ‡ z wykorzystaniem Chain of responsibility.

Z kolei wracajÄ…c juÅ¼ do Å›wiata IT, tego typu wzorzec sprawdzi siÄ™ bardzo dobrze we wszelkich **procesach autoryzacyjnych**. PoprawnoÅ›Ä‡ hasÅ‚a, przyznane uprawnienia, opÅ‚acona subskrypcja, naÅ‚oÅ¼one bany, iloÅ›Ä‡ Å›rodkÃ³w na koncie itd. Wszystkie te czynnoÅ›ci moÅ¼na wynieÅ›Ä‡ do osobnych obiektÃ³w i skÅ‚adaÄ‡ Å‚aÅ„cuchy (np. przy pomocy jakiejÅ› fabryki) w zaleÅ¼noÅ›ci od aktualnych potrzeb.

PrzykÅ‚adem bliÅ¼szym nam, frontendowcom, jest [event bubbling](https://javascript.info/bubbling-and-capturing), gdzie poszczegÃ³lne zdarzenia (np. click) obsÅ‚ugiwane sÄ… przez te elementy w drzewie DOM, ktÃ³re sÄ… do tego przygotowane (tj. napisaliÅ›my dla nich kod obsÅ‚ugujÄ…cy dany event).

To tyle suchej gadki â€“ spÃ³jrzmy w koÅ„cu w kod ğŸ˜‰

## PrzykÅ‚ad â€“ operacje pÅ‚atnicze

W poniÅ¼szym przykÅ‚adzie omÃ³wimy sobie Å‚aÅ„cuch zobowiÄ…zaÅ„ na podstawie kilku klas, ktÃ³rych moglibyÅ›my uÅ¼yÄ‡ przy tworzeniu systemu pÅ‚atnoÅ›ci. â€Å»Ä…daniemâ€ w tym przypadku bÄ™dzie zainicjowanie pÅ‚atnoÅ›ci. Poza samÄ… kwotÄ… posiadamy rÃ³wnieÅ¼ informacjÄ™ o tym, czy w przypadku danej operacji powinniÅ›my skorzystaÄ‡ z waluty tradycyjnej, czy wirtualnej. Dla waluty tradycyjnej uÅ¼yjemy konta bankowego lub PayPal, natomiast waluty wirtualne, jakie mamy w naszym portfelu to Bitcoin oraz Dogecoin. ÅaÅ„cuch, ktÃ³ry stworzymy, preferuje w pierwszej kolejnoÅ›ci skorzystanie z konta PayPal (waluta tradycyjna) bÄ…dÅº Bitcoina (waluta wirtualna).

SzczegÃ³Å‚owe wyjaÅ›nienie rÃ³l poszczegÃ³lnych klas znajdziemy w **komentarzach** do kodu.

```js showLineNumbers
/**
 * Pomocniczy obiekt na cele przykÅ‚adu.
 * Symuluje stan naszego konta w rÃ³Å¼nych walutach.
 */
const fakeBalanceApi = {
  payPal: 50,
  bankAccount: 200,
  /* WiedzieliÅ›cie, Å¼e tak rÃ³wnieÅ¼ moÅ¼na zapisywaÄ‡ liczby w JS? ğŸ˜‰ */
  bitcoin: 1_000,
  dogecoin: 10_000_000,
};

/**
 * Klasa tworzÄ…ca obiekt obsÅ‚ugujÄ…cy, tj. "ogniwo Å‚aÅ„cucha".
 * WÅ‚aÅ›ciwe obiekty bÄ™dÄ… rozszerzaÅ‚y tÄ™ wÅ‚aÅ›nie klasÄ™.
 */
class Account {
  /**
   * Metoda sÅ‚uÅ¼Ä…ca do "poÅ‚Ä…czenia" obecnego obiektu
   * ("ogniwa") z kolejnym obiektem w Å‚aÅ„cuchu.
   */
  setNextHandler(nextObj) {}

  /**
   * DomyÅ›lne zachowanie w przypadku, gdy Å¼aden z
   * elementÃ³w Å‚aÅ„cucha nie jest w stanie obsÅ‚uÅ¼yÄ‡
   * Å¼Ä…dania.
   */
  handlePayment(req) {
    const { amount } = req.getRequest();
    console.log(`Can't handle ${amount}$ ğŸ˜`);
  }
}

/**
 * Klasa tworzÄ…ca nowe Å¼Ä…danie - punk wejÅ›ciowy
 * do Å‚aÅ„cucha.
 */
class Request {
  constructor(request) {
    this.request = request;
    this.nextObj = new Account();
  }

  /**
   * Metoda zwracajÄ…ca aktualnie przetwarzane Å¼Ä…danie.
   */
  getRequest() {
    return this.request;
  }
}

/**
 * PoniÅ¼ej znajdujÄ… siÄ™ klasy tworzÄ…ce obiekty
 * obsÅ‚ugujÄ…ce. RozszerzajÄ… klasÄ™ "Account".
 */

class PayPal extends Account {
  constructor() {
    super();
    /**
     * Inicjalizacja zmiennej "nextObj", czyli kolejnego
     * obiektu w Å‚aÅ„cuchu.
     */
    this.nextObj = new Account();
  }

  setNextHandler(nextObj) {
    this.nextObj = nextObj;
  }

  handlePayment(req) {
    const { useVirtual, amount } = req.getRequest();
    if (!useVirtual && amount < fakeBalanceApi.payPal) {
      /* Obiekt potrafi obsÅ‚uÅ¼yÄ‡ Å¼Ä…danie, wiÄ™c przystÄ™puje do pracy. */
      console.log(`Handle ${amount}$ with PayPall ğŸ’³`);
    } else {
      /* Przekazanie Å¼Ä…dania do kolejnego obiektu. */
      this.nextObj.handlePayment(req);
    }
  }
}

class BankAccount extends Account {
  constructor() {
    super();
    this.nextObj = new Account();
  }

  setNextHandler(nextObj) {
    this.nextObj = nextObj;
  }

  handlePayment(req) {
    const { useVirtual, amount } = req.getRequest();
    if (!useVirtual && amount < fakeBalanceApi.bankAccount) {
      console.log(`Handle ${amount}$ with Bank account ğŸ’°`);
    } else {
      this.nextObj.handlePayment(req);
    }
  }
}

class Bitcoin extends Account {
  constructor() {
    super();
    this.nextObj = new Account();
  }

  setNextHandler(nextObj) {
    this.nextObj = nextObj;
  }

  handlePayment(req) {
    const { useVirtual, amount } = req.getRequest();
    if (useVirtual && amount < fakeBalanceApi.bitcoin) {
      console.log(`Handle ${amount}$ with Bitcoin ğŸ’²`);
    } else {
      this.nextObj.handlePayment(req);
    }
  }
}

class Dogecoin extends Account {
  constructor() {
    super();
    this.nextObj = new Account();
  }

  setNextHandler(nextObj) {
    this.nextObj = nextObj;
  }

  handlePayment(req) {
    const { useVirtual, amount } = req.getRequest();
    if (useVirtual && amount < fakeBalanceApi.dogecoin) {
      console.log(`Handle ${amount}$ with Dogecoin ğŸ¶`);
    } else {
      this.nextObj.handlePayment(req);
    }
  }
}

/**
 * Utworzenie pojedynczych elementÃ³w Å‚aÅ„cucha
 * (obiektÃ³w obsÅ‚ugujÄ…cych)
 */
const h1 = new PayPal();
const h2 = new BankAccount();
const h3 = new Bitcoin();
const h4 = new Dogecoin();

/**
 * Tworzymy Å‚aÅ„cuch zobowiÄ…zaÅ„ z powyÅ¼szych obiektÃ³w:
 * request â¡ h1 â¡ h2 â¡ h3 â¡ h4 â¡ h5
 * ÅaÅ„cuch ten moÅ¼e wyglÄ…daÄ‡ rÃ³Å¼nie w zaleÅ¼noÅ›ci od
 * aktualnych wymagaÅ„.
 */

h1.setNextHandler(h2);
h2.setNextHandler(h3);
h3.setNextHandler(h4);

/* Testowanie Å‚aÅ„cuchÃ³w */

h1.handlePayment(new Request({ amount: 10, useVirtual: false }));
h1.handlePayment(new Request({ amount: 100, useVirtual: false }));
h1.handlePayment(new Request({ amount: 100, useVirtual: true }));
h1.handlePayment(new Request({ amount: 10_00, useVirtual: true }));
h1.handlePayment(new Request({ amount: 100_000_000, useVirtual: false }));
h1.handlePayment(new Request({ amount: 100, useVirtual: false }));
h1.handlePayment(new Request({ amount: 100_000_000, useVirtual: true }));

/* ÅaÅ„cuchÃ³w nie musimy uruchamiaÄ‡ od samego poczÄ…tku */

h3.handlePayment(new Request({ amount: 100, useVirtual: true }));
h3.handlePayment(new Request({ amount: 100, useVirtual: false }));
```

Wynik uruchomienia powyÅ¼szego kodu:

<img src={wynik.src} />

PowyÅ¼szy przykÅ‚ad tworzy nowe obiekty za pomocÄ… klas, jednak oczywiÅ›cie [moÅ¼emy skorzystaÄ‡ z innych metod](https://frontstack.pl/blog/obiekty-javascript-podstawy/). Å»Ä…danie, ktÃ³re przetwarzamy w kolejnych obiektach, bÄ™dzie obsÅ‚uÅ¼one tylko raz. W razie potrzeby moÅ¼emy rÃ³wnieÅ¼ nieco modyfikowaÄ‡ przekazywany obiekt (nie zmieniajÄ…c oczywiÅ›cie jego interfejsu) i w takiej formie przekazywaÄ‡ go dalej. Dodawane mogÄ… byÄ‡ informacje np. o opÅ‚aconym abonamencie. JeÅ¼eli abonament nie jest opÅ‚acony, Å‚aÅ„cuch moÅ¼e zostaÄ‡ przerwany. JeÅ¼eli jednak abonament jest opÅ‚acony, moÅ¼emy â€doczepiÄ‡â€ informacjÄ™ o wykupionych usÅ‚ugach, co moÅ¼e zostaÄ‡ wykorzystane przez jedno z kolejnych ogniw.

## Podsumowanie

Wzorzec _**Chain of responsibility**_ jest wzorcem doÅ›Ä‡ Å‚atwym do zrozumienia i zaimplementowania. Podobnie jak w przypadku innych wzorcÃ³w, skorzystanie z Å‚aÅ„cucha pozwoli nam pisaÄ‡ bardziej czytelny, moduÅ‚owy i reuÅ¼ywalny kod. RÃ³wnieÅ¼ przyszÅ‚y refactor, ktÃ³ry moÅ¼e nas czekaÄ‡ w kodzie, bÄ™dzie stosunkowy Å‚atwy, jeÅ¼eli bÄ™dzie polegaÅ‚ jedynie na dodaniu / zamienieniu / usuniÄ™ciu jednego elementu z Å‚aÅ„cucha. Warto stosowaÄ‡ ten wzorzec w sytuacjach, gdzie mamy do czynienia z wieloma obiektami, ktÃ³re majÄ… wykonywaÄ‡ okreÅ›lone zadania w okreÅ›lonym porzÄ…dku.
