import { Vimeo } from "../../components/posts";
import { Table } from "./table";

import simpsons from "./simpson.gif";

export const meta = {
  title: "Lokalizacja uÅ¼ytkownika",
  seo_desc:
    "Lokalizacja uÅ¼ytkownika jest obecnie popularnym trendem w aplikacjach webowych. SprawdÅº w jaki sposÃ³b moÅ¼esz jÄ… zaimplementowaÄ‡.",
  short:
    "ArtykuÅ‚ omawia techniki lokalizacji uÅ¼ytkownika w kontekÅ›cie stron i aplikacji internetowych, koncentrujÄ…c siÄ™ na Geolocation API i IP Lookup. Porusza wyzwania i ograniczenia tych metod, a takÅ¼e przedstawia moÅ¼liwe rozwiÄ…zania, takie jak uÅ¼ycie zewnÄ™trznych usÅ‚ug do tÅ‚umaczenia wspÃ³Å‚rzÄ™dnych na konkretne adresy.",
  date: "2021-07-13",
  tags: ["FrontOps"],
};

Na naszych stronach i aplikacjach webowych coraz czÄ™Å›ciej siÄ™gamy po narzÄ™dzia, ktÃ³re pozwalajÄ… nam dowiedzieÄ‡ siÄ™ nieco wiÄ™cej na temat odwiedzajÄ…cego. DziÄ™ki temu moÅ¼emy zaproponowaÄ‡ mu treÅ›ci bÄ…dÅº funkcjonalnoÅ›ci, ktÃ³re bÄ™dÄ… duÅ¼o bardziej spersonalizowane. DoÅ›Ä‡ popularnÄ… technikÄ… z tym zwiÄ…zanÄ… jest lokalizacja uÅ¼ytkownika. W tym krÃ³tkim artykule omÃ³wimy sobie dwa najpopularniejsze sposoby na to, aby dowiedzieÄ‡ siÄ™ skÄ…d â€klikajÄ…â€ osoby odwiedzajÄ…ce naszÄ… stronÄ™ / aplikacjÄ™.

<img src={simpsons.src} />

## Geolocation API

Pierwszym rozwiÄ…zaniem, ktÃ³re zapewne przychodzi nam do gÅ‚owy, jest skorzystanie z [geolokalizacji](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation_API), ktÃ³rÄ… mamy do dyspozycji w przeglÄ…darce uÅ¼ytkownika. Jest to natywne rozwiÄ…zanie, dziÄ™ki ktÃ³remu nie musimy korzystaÄ‡ z Å¼adnych zewnÄ™trznych bibliotek lub usÅ‚ug. W rezultacie otrzymamy wspÃ³Å‚rzÄ™dne geograficzne pod ktÃ³rymi (wedÅ‚ug przeglÄ…darki) znajduje siÄ™ przeglÄ…dajÄ…cy naszÄ… stronÄ™.

W celu okreÅ›lenia lokalizacji przeglÄ…darka bÄ™dzie korzystaÅ‚a z takich danych jak sygnaÅ‚ GPS, dane operatorÃ³w komunikacyjnych, adres IP, dane z sieci Bluetooth i WiFi. Widzimy wiÄ™c, Å¼e dokÅ‚adnoÅ›Ä‡ takiego pomiaru bÄ™dzie w duÅ¼ej mierze zaleÅ¼na od urzÄ…dzenia, na ktÃ³rym nasza strona bÄ™dzie przeglÄ…dana i od tego, jak wiele pozwoleÅ„ przyznaÅ‚ uÅ¼ytkownik swojej przeglÄ…darce.

Lokalizacja uÅ¼ytkownika bÄ™dzie rÃ³wnieÅ¼ moÅ¼liwa tylko w przypadku, gdy przeglÄ…dajÄ…cy udzieli na to zgody rÃ³wnieÅ¼ juÅ¼ bezpoÅ›rednio na stronie. W przeciwnym razie Geolocation API nie zwrÃ³ci nam Å¼adnych danych. Co wiÄ™cej, gdy uÅ¼ytkownik raz zdecyduje siÄ™ odmÃ³wiÄ‡ dostÄ™pu do swoich danych lokalizacyjnych, przy ponownym odwiedzeniu naszej strony nie zostanie o to ponownie zapytany. PrzeglÄ…darka zapamiÄ™ta jego wybÃ³r i zablokuje nam dostÄ™p do API.

MÃ³wiÄ…c o danych, te nie sÄ… jakieÅ› bardzo wyczerpujÄ…ce â€“ najwaÅ¼niejszymi danymi, jakie otrzymamy od przeglÄ…darki, bÄ™dÄ… wspÃ³Å‚rzÄ™dne geograficzne:

```js
/* PrzykÅ‚adowy obiekt zwracany przez Geolocation API: */
{
    "altitude": null, // wysokoÅ›Ä‡ nad poziomem morza
    "altitudeAccuracy": null,  // dokÅ‚adnoÅ›Ä‡ pomiaru wysokoÅ›ci nad poz. morza w metrach
    "heading": null, // kierunek (w stopniach), w ktÃ³rym zwrÃ³cone jest urzÄ…dzenie (0 = pÃ³Å‚noc, 90 = wschÃ³d itd.)
    "latitude": 52.5884591, // szerokoÅ›Ä‡ geograficzna
    "longitude": 21.7366616, // wysokoÅ›Ä‡ geograficzna
    "accuracy": 2741, // dokÅ‚adnoÅ›Ä‡ pomiaru wysokoÅ›ci/szerokoÅ›ci geogr. wyraÅ¼ona w metrach
    "speed": null // szybkoÅ›Ä‡ urzÄ…dzenia wyraÅ¼ona w m/s
}
```

Samo posiadanie powyÅ¼szych danych nie daje nam zbyt wielu opcji. Prawdopodobnie w dalszym ciÄ…gu bÄ™dziemy musieli skorzystaÄ‡ z jakiegoÅ› zewnÄ™trznego serwisu, ktÃ³ry przetÅ‚umaczy nam wspÃ³Å‚rzÄ™dne na nazwÄ™ kraju, miasta, adres itp.

Dane lokalizacyjne moÅ¼emy pobieraÄ‡ na dwa sposoby â€“ jednorazowo oraz ciÄ…gÅ‚y nasÅ‚uch na zmianÄ™ lokalizacji:

```js
const onSuccess = (pos) => console.log(pos);
const onError = (err) => console.log(err);

if (!navigator.geolocation) {
  alert("Geolocation is not supported by your browser");
} else {
  /* Jednorazowe pobranie danych. Funkcja "onSuccess" wykona siÄ™ tylko raz. */
  navigator.geolocation.getCurrentPosition(onSuccess, onError);

  /* NasÅ‚uch na zmianÄ™ lokalizacji. Funkcja "onSuccess" wykona siÄ™
  przy kaÅ¼dej zmianie pozycji. */
  navigator.geolocation.watchPosition(onSuccess, onError);
}
```

## Podmiana lokalizacji

Kolejnym problemem, ktÃ³ry posiadamy w przypadku lokalizacja uÅ¼ytkownika za pomocÄ… Geolocation API jest fakt, iÅ¼ moÅ¼emy bardzo Å‚atwo oszukaÄ‡ przeglÄ…darkÄ™ i zmieniÄ‡ naszÄ… pozycjÄ™ jedynie za pomocÄ… DevTools. PoniÅ¼szy materiaÅ‚ pokazuje, w jaki sposÃ³b moÅ¼emy to osiÄ…gnÄ…Ä‡:

<Vimeo videoLink="https://vimeo.com/826679939/ae9d527842" />

Widzimy wiÄ™c, iÅ¼ lokalizacja uÅ¼ytkownika za pomocÄ… Geolocation API jest z jednej strony doÅ›Ä‡ Å‚atwa (wystarczy jedynie kilka linijek kodu JavaScript), jednak jest to metoda bardzo zawodna i nie powinniÅ›my opieraÄ‡ na niej gÅ‚Ã³wnych funkcjonalnoÅ›ci naszych stron i aplikacji.

## IP Lookup

Kolejnym sposobem na lokalizacjÄ™ uÅ¼ytkownika moÅ¼e byÄ‡ tzw. â€IP Lookupâ€, czyli okreÅ›lanie pozycji jedynie za pomocÄ… adresu IP. Jest sposÃ³b, z ktÃ³rego nie moÅ¼emy skorzystaÄ‡ bezpoÅ›rednio w naszej aplikacji frontowej, poniewaÅ¼ za pomocÄ… JavaScript nie jesteÅ›my w stanie poznaÄ‡ adresu IP przeglÄ…dajÄ…cego stronÄ™.

Adres ten moÅ¼emy odczytaÄ‡ z nagÅ‚Ã³wkÃ³w HTTP zapytaÅ„ sieciowych, a wiÄ™c gÅ‚Ã³wnie na backend-owej czÄ™Å›ci naszej aplikacji. Na tej wÅ‚aÅ›nie zasadzie dziaÅ‚ajÄ… usÅ‚ugi, ktÃ³re oferujÄ… nam geolokalizacje uÅ¼ytkownika na podstawie jego adresu IP. W kodzie naszej aplikacji wykonujemy request pod wskazany adres (w requeÅ›cie bÄ™dzie adres IP przeglÄ…dajÄ…cego) i w odpowiedzi otrzymujemy wszystkie informacje, jakie byÅ‚a w stanie okreÅ›liÄ‡ uÅ¼ywana przez nas usÅ‚uga.

OczywiÅ›cie zadziaÅ‚a to poprawnie wtedy, gdy request bÄ™dzie wykonany z przeglÄ…darki uÅ¼ytkownika. W przypadku generowania stron za pomocÄ… SSR adresem IP w nagÅ‚Ã³wku bÄ™dzie adres naszego serwera, ale niemal kaÅ¼dy dostawca usÅ‚ugi IP Lookup pozwala na przesÅ‚anie dowolnego adresu IP jako jeden z parametrÃ³w zapytania sieciowego. Wtedy adres z nagÅ‚Ã³wka jest pomijany i uÅ¼yty zostanie ten, ktÃ³ry sami zdefiniujemy.

W pierwszej chwili moÅ¼e wiÄ™c wydawaÄ‡ siÄ™ bezsensowne korzystanie z usÅ‚ug IP Lookup po stronie serwerowej, jednakÅ¼e naleÅ¼y pamiÄ™taÄ‡ o tym, iÅ¼ usÅ‚ugi te sÄ… zazwyczaj pÅ‚atne. NajpopularniejszÄ… metodÄ… weryfikacji tego, czy moÅ¼emy skorzystaÄ‡ z danego API, jest umieszczenie w requeÅ›cie klucza API. To na jego podstawie dostawca usÅ‚ugi stwierdza, czy takie zapytanie w ogÃ³le bÄ™dzie obsÅ‚uÅ¼one. Wszystkie zapytania sieciowe moÅ¼emy podejrzeÄ‡ w zakÅ‚adce â€Networkâ€ DevToolsÃ³w, wiÄ™c nawet jeÅ¼eli klucz nie bÄ™dzie znajdowaÅ‚ siÄ™ jawnie w kodzie (np. bÄ™dzie odczytywany ze zmiennych Å›rodowiskowych), to i tak bez problemu bÄ™dzie moÅ¼na podejrzeÄ‡ go w DevTools.

Prawdopodobnie czÄ™Å›Ä‡ dostawcÃ³w usÅ‚ug typu â€IP Lookupâ€ bÄ™dzie oferowaÅ‚o nam moÅ¼liwoÅ›Ä‡ ustawienie domeny, spod ktÃ³rej bÄ™dÄ… akceptowane zapytania, jednakÅ¼e nie bÄ™dzie to reguÅ‚Ä… i tego typu informacji jak klucze API lepiej nie pokazywaÄ‡ publicznie.

Lepszym rozwiÄ…zaniem w tym przypadku bÄ™dzie wykonywanie zapytaÅ„ z naszego serwera i przekazywanie na front danych zwrÃ³conych przez usÅ‚ugodawcÄ™. W takim przypadku w pierwszej kolejnoÅ›ci samodzielnie odczytujemy adres IP z requestu przychodzÄ…cego na nasz serwer i nastÄ™pnie wykonujemy kolejne zapytanie pod usÅ‚ugÄ™ IP Lookup podajÄ…c odczytany przez nas adres.

## Naszâ€¦ serwerâ€¦ ğŸ˜¨

Blog poÅ›wiÄ™cony frontendowi a tutaj mowa o samodzielnym stawianiu serwera i obsÅ‚udze zapytaÅ„? Kilka lat temu byÅ‚by to pewien problem dla frontendowcÃ³w â€“ czekaÅ‚oby nas pewnie stawianie jakiegoÅ› serwera w [Node](https://expressjs.com/).js bÄ…dÅº korzystanie z usÅ‚ug typu [AWS Lambda](https://aws.amazon.com/lambda/), jednak na szczÄ™Å›cie dzisiaj moÅ¼emy zrealizowaÄ‡ SSR dosyÄ‡ prosto za pomocÄ… [Next.js](https://nextjs.org/). Nie bÄ™dÄ™ tutaj rozwodziÅ‚ siÄ™ nad tym, w jaki sposÃ³b to zrobiÄ‡ (tym bardziej Å¼e Next.js jest jedynie jednÄ… z kilku opcji, czytelnik tego posta moÅ¼e zdecydowaÄ‡ siÄ™ na zupeÅ‚nie inne podejÅ›cie), ale na samym koÅ„cu tego wpisu podam link do mini projektu, w ktÃ³rym porÃ³wnaÅ‚em wszystkie opisane tutaj metody lokalizacji uÅ¼ytkownika.

## PrzykÅ‚adowi dostawcy usÅ‚ug IP Lookup

W poniÅ¼szej tabeli zebraÅ‚em kilku najbardziej popularnych dostawcÃ³w usÅ‚ug typu IP Lookup. SÄ… to dostawcy, ktÃ³rzy najczÄ™Å›ciej byli polecani w przejrzanych przeze mnie postach na StackOverflow oraz innych blogach. KaÅ¼dy z nich oferujÄ… pewnÄ… darmowÄ… liczbÄ™ requestÃ³w, dziÄ™ki czemu moÅ¼emy spokojnie to przetestowaÄ‡ a w przypadku mniejszych, pobocznych projektÃ³w byÄ‡ moÅ¼e limity te nie zostanÄ… nawet przekroczone.

PamiÄ™tajmy o tym, Å¼e adres IP nie jest rÃ³wnieÅ¼ caÅ‚kowicie wiarygodnym ÅºrÃ³dÅ‚em danych o uÅ¼ytkowniku. MoÅ¼e on zostaÄ‡ doÅ›Ä‡ Å‚atwo podmieniony poprzez uÅ¼ywanie [serwerÃ³w proxy](https://pl.wikipedia.org/wiki/Serwer_po%C5%9Brednicz%C4%85cy) bÄ…dÅº [VPN](https://pl.wikipedia.org/wiki/Wirtualna_sie%C4%87_prywatna). Zdecydowana wiÄ™kszoÅ›Ä‡ uÅ¼ytkownikÃ³w Internetu jednak nie korzysta z takich rozwiÄ…zaÅ„, wiÄ™c z caÅ‚kiem sporym prawdopodobieÅ„stwem moÅ¼emy zaÅ‚oÅ¼yÄ‡, iÅ¼ lokalizacja uÅ¼ytkownika w tym przypadku bÄ™dzie doÅ›Ä‡ wiarygodna.

<Table />

## PorÃ³wnanie zwracanych danych ğŸ“Š

KaÅ¼dy z powyÅ¼szych dostawcÃ³w bÄ™dzie na sobie tylko znany sposÃ³b prÃ³bowaÅ‚ okreÅ›liÄ‡ lokalizacjÄ™ uÅ¼ytkownika. KaÅ¼dy z nich bÄ™dzie rÃ³wnieÅ¼ zwracaÅ‚ nam rÃ³Å¼ne zestawy danych. Wszyscy powyÅ¼sze serwisy (oraz Geolocation API) zostaÅ‚y przeze mnie porÃ³wnane na jednej stronie. DziÄ™ki temu moÅ¼emy szybko sobie sprawdziÄ‡ jakie dane na nasz temat oferujÄ… poszczegÃ³lni usÅ‚ugodawcy, a takÅ¼e nasza przeglÄ…darka.

Strona ta zostaÅ‚a zrealizowana za pomocÄ… Next.js a link do wersji online oraz do repozytorium znajdujÄ… siÄ™ poniÅ¼ej:

- Wersja online: [ğŸ”— link](https://locations.vercel.app/)
- Repozytorium GitHub: [ğŸ”— link](https://github.com/kamiljozwik/location)

## Podsumowanie

WspÃ³Å‚czesny rozwÃ³j technologii pozwala na stosowanie coraz bardziej zaawansowanych i spersonalizowanych rozwiÄ…zaÅ„ w naszych stronach i aplikacjach. Jednym z kluczowych elementÃ³w takiej personalizacji jest lokalizacja uÅ¼ytkownika, ktÃ³rÄ… moÅ¼emy uzyskaÄ‡ na wiele rÃ³Å¼nych sposobÃ³w.

Pierwszym z nich jest Geolocation API, natywne narzÄ™dzie dostÄ™pne w przeglÄ…darce uÅ¼ytkownika, ktÃ³re jednak ma pewne ograniczenia. DziaÅ‚a na podstawie wielu ÅºrÃ³deÅ‚ danych, ale jego efektywnoÅ›Ä‡ zaleÅ¼y od wielu czynnikÃ³w, w tym od zgody uÅ¼ytkownika na udostÄ™pnienie swojej lokalizacji.

DrugÄ… metodÄ… jest IP Lookup, technika polegajÄ…ca na okreÅ›laniu lokalizacji uÅ¼ytkownika za pomocÄ… jego adresu IP. Jest to metoda bardziej niezawodna, ale wymaga korzystania z zewnÄ™trznych usÅ‚ug i nie jest dostÄ™pna bezpoÅ›rednio w aplikacji frontowej.

KaÅ¼da z tych technik ma swoje zalety i wady, a wybÃ³r miÄ™dzy nimi zaleÅ¼y od specyfiki projektu i wymagaÅ„ stawianych przed aplikacjÄ…. Warto pamiÄ™taÄ‡, Å¼e Å¼adne z tych rozwiÄ…zaÅ„ nie jest doskonaÅ‚e i nie zawsze jest w 100% wiarygodne, ale mimo to stanowiÄ… one waÅ¼ne narzÄ™dzie w tworzeniu spersonalizowanych doÅ›wiadczeÅ„ dla uÅ¼ytkownikÃ³w naszych stron i aplikacji.
