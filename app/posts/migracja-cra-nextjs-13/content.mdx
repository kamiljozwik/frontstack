import { Info } from "../../components/posts";

import { Table } from "./Table";

export const meta = {
  title: "Migracja CRA + React Router v6 do Next.js 13 (app)",
  seo_desc:
    "Migracja CRA do Next.js 13 (app) jest zabiegiem, kt贸ry w niedalekiej przyszoci mo偶e okaza si bardzo popularny. W tym pocie opisuj jak zacz.",
  short:
    "Migracja CRA do Next.js 13 (app) jest zabiegiem, kt贸ry w niedalekiej przyszoci mo偶e czeka wiele obecnych aplikacji. W tym pocie zobaczymy w jaki spos贸b mo偶emy dokona stopniowej migracji aplikacji CRA z React Ruterem do frameworka Next.js.",
  date: "2023-06-01",
  tags: ["React", "Next.js"],
};

Je偶eli czytasz ten wpis, to zapewne dokadnie wiesz, czego szukasz, wic pozwol sobie pomin wyjanianie czym s CRA, React Router i Next.js. Obecnie stoj przed zadaniem migracji redniej wielkoci aplikacji opartej na React Routerze v6 do Next.js 13 (TypeScript). Aplikacja jest cay czas w midzyczasie rozwijana, wic nie chc traci czasu (i zdrowia ) na przepisywanie wszystkiego na raz. Zamiast tego chciabym przeprowadzi migracj krok po kroku, tak aby nie zatrzymaa ona na dugi czas pozostaego developmentu.

W tym celu postanowiem sprawdzi, czy w pierwszym kroku dam rad uruchomi aplikacj wraz z React Routerem w Next.js bez 偶adnych zmian w kodzie. Next.js jest frameworkiem, kt贸ry mo偶na adaptowa inkrementalnie, wic powinno si da to zrobi w miar bezbolenie. Majc ju偶 aplikacj w Next.js, bd m贸g zaj si kolejnym krokiem, jakim jest konteneryzacja oraz hosting. Majc ju偶 uruchomion i poprawnie hostowan aplikacj, bd m贸g spokojnie migrowa kolejne czci aplikacji bez blokowania pozostaego developmentu.

Czy wszystko p贸jdzie zgodnie z planem? Czas (oraz kolejne wpisy na tym blogu) poka偶e 

<Info title="Kod 藕r贸dowy">
  Cay kod opisywany w tym pocie znajdziesz [pod tym
  linkiem](https://github.com/kamiljozwik/cra-to-nextjs).

Dalej w treci artykuu, zamiast wkleja fragmenty kodu, do wszystkich krok贸w migracji bd linkowa odpowiednie commity, 偶eby post ten by kr贸tszy i czytelniejszy.

</Info>

## CRA + React Router v6

Zanim rzuc si na gbok wod, spr贸bowaem stworzy now bazow aplikacj CRA + React Router. Tutaj wielkiej filozofii nie byo. Skorzystaem z `npx create-react-app cra-to-nextjs --template typescript` i dorzuciem tam React Router v6 bazujc [na tym oficjalnym przykadzie](https://github.com/remix-run/react-router/tree/dev/examples/basic/src). Wszystko dziaao bez problemu. Wszystkie testy przechodziy, wic mogem przej do nastpnego kroku.

<Info title="Commit nr 1锔">
  Dodanie React Routera do CRA: [init CRA with
  react-router](https://github.com/kamiljozwik/cra-to-nextjs/commit/92b59d64205c20445e40e6a69c5c868b6cc66b88)
</Info>

## Instalacja Next.js

Kolejnym krokiem byo zainstalowanie Next.js. Tutaj najlepiej byo skorzysta z [dokumentacji na temat rcznej instalacji](https://nextjs.org/docs/getting-started/installation#manual-installation) w istniejcym ju偶 projekcie. Po instalacji Next.js usuwamy paczk `react-scripts` (bye bye CRA ), zmieniamy skrypty i dodajemy wymagane pliki `layout.tsx` oraz `page.tsx`.

Next.js skonfigurowany, przenosimy teraz nasz aplikacj.

## Przenoszenie aplikacji CRA

G贸wnym zao偶eniem tej migracji bya jak najmniejsza ingerencja w kod 藕r贸dowy, wic postanowiem po prostu skopiowa cay folder `src` (czyli aplikacj CRA) do folderu `app`. Aby mie pewno, 偶e Next nie bdzie pr贸bowa budowa folderu `src` jako strony pod adresem `localhost:3000/src/`, zmieniem nazw folderu na `_src`, aby tak jak m贸wi nam [dokumentacja](https://nextjs.org/docs/app/building-your-application/routing/colocation#private-folders), folder ten by ignorowany podczas routingu.

W Next.js istniej [inne sposoby](https://nextjs.org/docs/app/building-your-application/routing/colocation#project-organization-strategies) organizacji kodu (_"There is no 'right' or 'wrong' way when it comes to organizing your own files and folders in Next.js a project."_) i m贸gbym spokojnie zostawi folder `src` [poza](https://nextjs.org/docs/app/building-your-application/routing/colocation#store-project-files-outside-of-app) `app`, ale chciaem spr贸bowa przeniesienia wszystkiego w jedno miejsce, poniewa偶 docelowo tak wanie chciabym zorganizowa kod w migrowanym projekcie.

Jedna rzecz, o kt贸rej musiaem pamita to deklaracja `use client` w folderze `app/page.tsx`. Jest to wymagane, aby Next.js wiedzia, 偶e aplikacja jest aplikacj klienck (a nie serwerow, na serwerze React Router nie zadziaa). Tyle wystarczyo, aby React Router zadziaa w Next.js 

## Testy

Pozbywajc si `react-scripts` pozbylimy si r贸wnie偶 niejako wbudowanej konfiguracji dla `Jest` i `React Testing Library`. Na szczcie tutaj ponownie ratuje nas dokumentacja, kt贸ra [opisuje jak skonfigurowa testy](https://nextjs.org/docs/pages/building-your-application/optimizing/testing) w naszej aplikacji.

<Info title="Commit nr 2锔">
  Migracja React Routera do Next.js : [move src to app
  folder](https://github.com/kamiljozwik/cra-to-nextjs/commit/e5d7974ee66be0158c8871f76a5506b67d091c7f)
</Info>

## Nawigacja

W tym momencie w naszej aplikacji dziaaj dwa systemy odpowiedzialne za routing: React Router oraz oparty na folderach routing wbudowany w Next.js. Zakadajc, 偶e bd chcia stopniowo przenosi kod _per_ strona, musz mie pewno, 偶e mog nawigowa pomidzy stronami w obu systemach.

Zar贸wno React Router, jak i Next.js korzystaj z komponentu o nazwie `<Link />` do nawigacji (eksport jest domylny, wic mo偶emy u偶y dowolnej nazwy, ale w dokumentacjach najczsciej znajdziemy wanie `Link`). Stworzyem wic kilka dodatkowych stron, 偶eby sprawdzi, kt贸rej metody nawigacji powinienem u偶y w zale偶noci od tego, czy chc nawigowa z/do strony React Router, czy Next.js.

W tym celu stworzyem now stron `/blog` za pomoc Server Component贸w (Next.js) oraz now stron `/login`, 偶eby mie r贸wnie偶 niezagnie偶d偶on stron w React Routerze. Struktura plik贸w wyglda teraz nastpujco:

<img src="/blog/migracja-cra-nextjs-13/routes.webp" />

Na ka偶dej z tych stron umieciem linki do innych stron, aby sprawdzi, jak zachowuj si one w obu systemach nawigacji. Link do commita z tymi zmianami znajduje si nieco dalej, ale zanim zaczniemy testowa nawigacj, warto zaj si jeszcze jedn rzecz.

Next.js daje nam mo偶liwo zdefiniowania tzw. [rewrites](https://nextjs.org/docs/pages/api-reference/next-config-js/rewrites), co znacznie usprawni nam dziaanie naszej nawigacji. Dodajc `rewrites()` do `next.config.js` tak jak poni偶ej:

```js title="next.config.js"
const nextConfig = {
  async rewrites() {
    return [
      {
        source: "/:any*",
        destination: "/",
      },
    ];
  },
};
```

otrzymamy mo偶liwo nawigowania do stron i podstron React Routera po wpisaniu w pasku adresu konkretnego URL, np. `localhost:3000/login`. Bez tego, pr贸ba nawigacji do tych stron zakoczy si bdem `404`, poniewa偶 Next.js nic nie wie o istnieniu tej strony. Z powy偶szym `rewrites()` trafimy na stron g贸wn, tam zaadujemy React Routera i on ju偶 zadba o poprawn nawigacj, poniewa偶 _path_ `/login` zostanie zachowany przy przekierowaniu. Bdzie nam to r贸wnie偶 mocno pomagao przy nawigacji ze stron Server Component贸w do stron React Routera.

Poni偶ej listuj **kilka wniosk贸w** opisujcych zachowania link贸w w obu systemach nawigacji (z zastosowaniem `rewrites()`):

- na stronach Next.js oczywicie nie mo偶emy u偶ywa komponentu `<Link />` z React Routera. Tutaj mamy do dyspozycji tylko komponent `<Link />` z Next.js oraz ewentualnie znacznik `<a href=''>`
- ze stron Next.js mo偶emy nawigowa do dowolnej strony React Routera (zar贸wno zagnie偶d偶onej np. `/about` jak i niezagnie偶d偶onej `/login` ) za pomoc komponentu `<Link />`
- ze stron React Routera nie mo偶emy nawigowa do stron Next.js za pomoc komponentu `<Link />` z React Routera (trafimy na stron `404`). W tym przypadku musimy u偶y komponentu `<Link />` z Next.js
- ze stron React Routera nie mo偶emy nawigowa do innych stron React Routera za pomoc komponentu `<Link />` z Next.js (zmieni si adres w pasku przegldarki, ale nie wywietli si odpowiednia strona).

Poza tym oczywicie bez problemu dziaa nawigacja pomidzy stronami React Routera za pomoc komponentu `<Link />` z React Routera oraz nawigacja pomidzy stronami Next.js za pomoc komponentu `<Link />` z Next.js.

<Table />

## Build

Na samym kocu spr贸bowaem jeszcze zbudowa m贸j projekt. Lokalnie (`yarn dev`) wszystko dziaao bez problemu, ale po odpaleniu `yarn build` otrzymaem bd `ReferenceError: document is not defined`. Jak wida, React Router pr贸buje gdzie dosta si do obiektu `window.document`, kt贸ry nie istnieje w rodowisku Node.js. Wpadaem na to ju偶 wielokrotnie wczeniej, wic jak zawsze spr贸bowaem obej to prostym sprawdzeniem:

```js
typeof window === "undefined" ? null : <App />;
```

Tutaj build przeszed bez problemu i aplikacja uruchomia si (`yarn start`) prawidowo, ale gdy wr贸ciem do trybu lokalnego (`yarn dev`) w przegldarce pojawi si bd `Error: Hydration failed because the initial UI does not match what was rendered on the server.` Co si stao?

Po zaadowaniu aplikacji, Next.js:

1.  pr贸buje wstpnie wyrenderowa j na serwerze,
2.  wysya wynik do przegldarki i
3.  dokonuje "rehydracji" (_re-hydrates_) strony w przegldarce. Rehydracja oznacza, 偶e strona jest ponownie renderowana w przegldarce i por贸wnywana z wersj, kt贸ra zostaa wyrenderowana na serwerze. Jeli co si nie zgadza, to React zgasza bd.

Mo偶emy pozby si powy偶szego bdu, korzystajc z `useEffect`:

```js
const Page = () => {
  const [render, setRender] = useState(false);
  useEffect(() => setRender(true), []);

  return render ? (
    <BrowserRouter>
      <App />
    </BrowserRouter>
  ) : null;
};
```

Teraz gdy Next.js renderuje stron na serwerze, nie wykonuje 偶adnych wywoa z `useEffect` (`useEffect` jest uruchamiany tylko w przegldarce), czyli po prostu renderuje stron przy u偶yciu wartoci domylnych i zwraca wynik.

Gdy ta strona zostanie zaadowana przez przegldark, zrobi to samo: wyrenderuje stron przy u偶yciu wartoci domylnych. Jako 偶e domyln wartoci `render` jest `false`, przegldarka pocztkowo wyrenderuje warto `null`, co zgadza si z wersj strony renderowan przez serwer.

Natychmiast po tym przegldarka wykona wywoanie `useEffect`, kt贸re ustawi warto `render` na `true`. Strona zostanie teraz wyrenderowana w penej krasie. Pocztkowo tracimy troch czasu na renderowanie wartoci `null`, ale jest to znikoma ilo czasu i nie wpywa mocno na wydajno strony.

<Info title="Commit nr 3锔">
  Testowanie nawigacji : [play with
  Links](https://github.com/kamiljozwik/cra-to-nextjs/commit/060311c02a2b2881e68308e36ca45476132a320e)
</Info>

## Podsumowanie

Teraz ju偶 nasza aplikacja dziaa prawidowo i mamy mo偶liwo stopniowego przenoszenia kodu z React Routera do Next.js. Poni偶ej podsumowanie wszystkich krok贸w migracji:

- Stworzenie aplikacji CRA z React Routerem v6
- Instalacja Next.js oraz usunicie `react-scripts`
- Przeniesienie aplikacji CRA (folderu `src`) do folderu `app` i zmiana nazwy na `_src`
- Dodanie `rewrites()` do `next.config.js`
- Konfiguracja test贸w
- Dodanie kilku stron do testowania nawigacji
- Naprawienie bdu `ReferenceError: document is not defined` podczas budowania aplikacji
- Naprawienie bdu `Error: Hydration failed because the initial UI does not match what was rendered on the server.` podczas uruchamiania aplikacji w trybie deweloperskim

Myl, 偶e na tym etapie mo偶na ju偶 podchodzi do migracji wikszych, penoprawnych aplikacji opartych na React Routerze v6 do Next.js 13. Tutaj mielimy do czynienia z bardzo prostym przykadem i przy bardziej rozbudowanych projektach na pewno bd wychodziy kolejne problemy, ale przynajmniej mamy ju偶 podstawy, na kt贸rych mo偶emy budowa.

Wydaje si, 偶e ciekaw rzecz do przetestowania bdzie r贸wnie偶 stopniowa migracja aplikacji zbudowanej na Reduxie ([redux-toolkit](https://redux-toolkit.js.org/)) i dzielenie stanu pomidzy stronami CRA i Next.js, ale to ju偶 zdecydowanie temat na kolejny wpis.
